# k8s/20-networkpolicies-allow.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata: { name: allow-workers-to-rabbit, namespace: bookstore }
spec:
  podSelector: { matchLabels: { app: rabbitmq } }
  policyTypes: ["Ingress"]
  ingress:
  - from:
    - podSelector: { matchLabels: { app: payment } }
    - podSelector: { matchLabels: { app: inventory } }
    - podSelector: { matchLabels: { app: notify } }
    ports: [ { port: 5672, protocol: TCP } ]
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata: { name: allow-catalog-to-reco, namespace: bookstore }
spec:
  podSelector: { matchLabels: { app: recommendation } }
  policyTypes: ["Ingress"]
  ingress:
  - from: [ { podSelector: { matchLabels: { app: catalog } } } ]
    ports: [ { port: 50051, protocol: TCP } ]
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata: { name: allow-nlb-to-http-services, namespace: bookstore }
spec:
  podSelector:
    matchExpressions:
    - key: app
      operator: In
      values:
      - catalog-service
      - cart-service
      - order-service
      - frontend
  policyTypes: ["Ingress"]
  ingress:
  - from:
    - namespaceSelector: {}
    - ipBlock: { cidr: "10.0.0.0/16" }
    ports:
    - { port: 8080, protocol: TCP }
    - { port: 8000, protocol: TCP }
    - { port: 80, protocol: TCP }
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata: { name: allow-vpc-egress, namespace: bookstore }
spec:
  podSelector: {}
  policyTypes: ["Egress"]
  egress:
  - to:
    - ipBlock: { cidr: "10.0.0.0/16" }
    - ipBlock: { cidr: "172.20.0.0/16" }
